const express = require('express');
const router = express.Router();
const axios = require('axios');

router.post('/vulnerability-scan', async (req, res) => {
  const { url } = req.body;

  if (!url) {
    return res.status(400).json({ error: 'URL is required' });
  }

  try {
    // Try fetching headers
    const response = await axios.get(url, { timeout: 5000 });

    const headers = response.headers;
    const issues = [];

    // Header-based security checks
    if (!headers['x-frame-options']) {
      issues.push({ type: 'Clickjacking', severity: 'Medium', message: 'Missing X-Frame-Options header' });
    }

    if (!headers['content-security-policy']) {
      issues.push({ type: 'XSS', severity: 'High', message: 'Missing Content-Security-Policy header' });
    }

    if (!headers['x-content-type-options']) {
      issues.push({ type: 'MIME Sniffing', severity: 'Low', message: 'Missing X-Content-Type-Options header' });
    }

    if (!headers['strict-transport-security']) {
      issues.push({ type: 'Insecure Transport', severity: 'High', message: 'Missing Strict-Transport-Security header' });
    }

    res.json({
      status: 'Scan complete',
      target: url,
      issues: issues.length > 0 ? issues : [{ message: 'No major vulnerabilities found.', severity: 'None' }]
    });

  } catch (error) {
    res.status(500).json({
      error: `Failed to scan ${url}`,
      details: error.message
    });
  }
});

module.exports = router;
